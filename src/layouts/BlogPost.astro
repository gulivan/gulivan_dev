---
import BaseLayout from './BaseLayout.astro';
import type { Locale } from '../lib/i18n';
import { getTranslations, formatDate } from '../lib/i18n';
import { getBaseSlug, localizedPath } from '../lib/locale';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface PostLink {
  slug: string;
  title: string;
}

interface Props {
  title: string;
  pubDate: Date;
  description: string;
  tags?: string[];
  readingTime?: number;
  headings?: Heading[];
  prevPost?: PostLink | null;
  nextPost?: PostLink | null;
  locale?: Locale;
  postId?: string;
}

const { title, pubDate, description, tags, readingTime, headings, prevPost, nextPost, locale: localeProp, postId } = Astro.props;
const locale = localeProp ?? (Astro.currentLocale as Locale) ?? 'en';
const t = getTranslations(locale);
const formattedDate = formatDate(pubDate, locale);

const tocHeadings = (headings ?? []).filter((h) => h.depth <= 3);

const ogSlug = postId ? getBaseSlug(postId) : Astro.params.slug;
---

<BaseLayout
  title={title}
  description={description}
  ogImage={`${Astro.site}og/${ogSlug}.png`}
  ogType="article"
  canonicalUrl={Astro.url.href}
  publishedTime={pubDate.toISOString()}
  author="Ivan"
>
  <article>
    <header class="mb-8">
      <h1 class="text-4xl font-bold tracking-tight mb-2">{title}</h1>
      <div class="flex items-center gap-3 text-muted-foreground text-sm">
        <time datetime={pubDate.toISOString()}>{formattedDate}</time>
        {readingTime && <span>&middot; {readingTime} {t.blog.minRead}</span>}
        {tags && tags.length > 0 && (
          <div class="flex gap-1.5 flex-wrap">
            {tags.map((tag) => (
              <span class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold text-secondary-foreground bg-secondary">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </header>

    {tocHeadings.length > 2 && (
      <nav class="mb-8 p-4 border rounded-md">
        <p class="text-sm font-semibold mb-2">{t.post.tableOfContents}</p>
        <ul class="text-sm space-y-1">
          {tocHeadings.map((h) => (
            <li style={`padding-left: ${(h.depth - 2) * 1}rem`}>
              <a href={`#${h.slug}`} class="text-muted-foreground hover:text-foreground transition-colors">
                {h.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}

    <div class="prose prose-neutral dark:prose-invert max-w-none">
      <slot />
    </div>

    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-6 border-t flex justify-between gap-4">
        {prevPost ? (
          <a href={localizedPath(`/blog/${prevPost.slug}/`, locale)} class="group text-sm">
            <span class="text-muted-foreground">&larr; {t.post.previous}</span>
            <span class="block font-medium group-hover:underline">{prevPost.title}</span>
          </a>
        ) : <div />}
        {nextPost ? (
          <a href={localizedPath(`/blog/${nextPost.slug}/`, locale)} class="group text-sm text-right">
            <span class="text-muted-foreground">{t.post.next} &rarr;</span>
            <span class="block font-medium group-hover:underline">{nextPost.title}</span>
          </a>
        ) : <div />}
      </nav>
    )}
  </article>
</BaseLayout>
